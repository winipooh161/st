import { MobileNavCore } from './MobileNavCore.js';
import { MobileNavEvents } from './MobileNavEvents.js';
import { MobileNavScroll } from './MobileNavScroll.js';
import { MobileNavPopup } from './MobileNavPopup.js';
import { MobileNavStorage } from './MobileNavStorage.js';
import { MobileNavUtils } from './MobileNavUtils.js';

class MobileNavWheelPicker {
    constructor() {
        console.log('üé° MobileNavWheelPicker: –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        try {
            this.core = new MobileNavCore();
            console.log('‚úÖ MobileNavCore –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            
            this.storage = new MobileNavStorage();
            console.log('‚úÖ MobileNavStorage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            
            this.scroll = new MobileNavScroll(this.core);
            console.log('‚úÖ MobileNavScroll –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            
            this.popup = new MobileNavPopup(this.core);
            console.log('‚úÖ MobileNavPopup –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            
            this.utils = new MobileNavUtils(this.core, this.scroll);
            console.log('‚úÖ MobileNavUtils –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            
            this.events = new MobileNavEvents(this.core, this.scroll, this.popup);
            console.log('‚úÖ MobileNavEvents –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        } catch (error) {
            console.error('‚õî –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', error);
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.MobileNavWheelPicker = this;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            try {
                this.initScrollTracking();
                console.log('‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
            } catch (error) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞:', error);
            }
        }, 300);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            try {
                this.initModalIntegration();
                console.log('‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            } catch (error) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π:', error);
            }
        }, 500);
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        this.setupPublicAPI();
        
        console.log('üé° MobileNavWheelPicker: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    }

    initModalIntegration() {
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
        if (window.modalPanel) {
            this.connectToModalSystem();
        } else {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            const checkInterval = setInterval(() => {
                if (window.modalPanel) {
                    this.connectToModalSystem();
                    clearInterval(checkInterval);
                }
            }, 100);
            
            // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                clearInterval(checkInterval);
                console.warn('MobileNavWheelPicker: –ú–æ–¥–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏');
            }, 5000);
        }
    }
    
    connectToModalSystem() {
        console.log('üîó MobileNavWheelPicker: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ');
        
        // –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –æ –Ω–∞—à–µ–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏
        if (window.modalPanel.mobileNavIntegration !== this) {
            window.modalPanel.mobileNavIntegration = this;
            console.log('‚úÖ MobileNavWheelPicker: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        this.registerModalHandlers();
    }
    
    registerModalHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (window.onModalBeforeOpen) {
            window.onModalBeforeOpen('qrScannerModal', (event) => {
                console.log('MobileNavWheelPicker: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–∫—Ä—ã—Ç–∏—é QR-—Å–∫–∞–Ω–µ—Ä–∞');
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
                if (this.popup && this.popup.isPopupOpen) {
                    this.popup.closePopup();
                }
            });
            
            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.addEventListener('modal.beforeOpen', (event) => {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                if (this.scroll && typeof this.scroll.blockHorizontalScroll === 'function') {
                    this.scroll.blockHorizontalScroll();
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞  
        if (window.onModalAfterClose) {
            document.addEventListener('modal.afterClose', (event) => {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                if (this.scroll && typeof this.scroll.unblockHorizontalScroll === 'function') {
                    this.scroll.unblockHorizontalScroll();
                }
            });
        }
    }
    
    setupPublicAPI() {
        // –ü—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        this.api = {
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
            show: () => this.core.showNavigation(),
            hide: () => this.core.hideNavigation(),
            
            // –†–∞–±–æ—Ç–∞ —Å –∏–∫–æ–Ω–∫–∞–º–∏
            convertToBackButton: (iconId) => this.core.convertIconToBackButton(iconId),
            restoreIcon: (iconId) => this.core.restoreIcon(iconId),
            
            // Popup —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            showPopup: (iconId) => this.popup.showPopup(iconId),
            closePopup: () => this.popup.closePopup(),
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ
            isPopupOpen: () => this.popup.isPopupOpen,
            getActiveIconId: () => this.events.activeIconId,
            
            // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
            modalSystemConnected: () => window.modalPanel && window.modalPanel.mobileNavIntegration === this
        };
          // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º API –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
        window.mobileNavAPI = this.api;
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    reinitialize() {
        console.log('üîÑ MobileNavWheelPicker: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è');
        
        // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —è–¥—Ä–æ
        if (this.core) {
            this.core.init();
        }
        
        // –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        if (this.events) {
            this.events.init();
        }
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –º–æ–¥–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ
        this.initModalIntegration();
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    destroy() {
        console.log('üóëÔ∏è MobileNavWheelPicker: –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º popup –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
        if (this.popup && this.popup.isPopupOpen) {
            this.popup.closePopup();
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∏–∫–æ–Ω–∫–∏
        if (this.events && this.events.activeIconId) {
            this.core.restoreIcon(this.events.activeIconId);
        }
          // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫–∏
        delete window.MobileNavWheelPicker;
        delete window.mobileNavAPI;
        
        // –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É
        if (window.modalPanel && window.modalPanel.mobileNavIntegration === this) {
            window.modalPanel.mobileNavIntegration = null;
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    initScrollTracking() {
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => this.setupScrollListeners(), 300);
            });
        } else {
            setTimeout(() => this.setupScrollListeners(), 300);
        }
    }
    
    // –ú–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–∫—Ä–æ–ª–ª–∞
    setupScrollListeners() {
        if (this.scroll) {
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            this.scroll.setupPageScrollListener();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            this.scroll.setupUserActivityListeners();
            
            console.log('üìú MobileNavWheelPicker: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        }
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setTimeout(() => new MobileNavWheelPicker(), 100);
});

export default MobileNavWheelPicker;
