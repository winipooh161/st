class f{constructor(){this.container=null,this.iconsContainer=null,this.items=[],this.centerPoint=0,this.sidePadding=16,this.isInitialized=!1,this.activeIconId=null,this.originalIcons=new Map,this.init(),this.checkEditorPage(),window.addEventListener("popstate",()=>this.checkEditorPage())}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.findElements(),this.initModalEventHandlers()}):setTimeout(()=>{this.findElements(),this.initModalEventHandlers()},100)}findElements(){if(this.container=document.getElementById("nav-scroll-container"),this.iconsContainer=document.getElementById("nav-icons-container"),!this.container||!this.iconsContainer){console.warn("MobileNavCore: Не все элементы найдены, повторная попытка через 500ms"),setTimeout(()=>this.findElements(),500);return}this.items=Array.from(this.iconsContainer.querySelectorAll(".mb-icon-wrapper")),this.calculateCenterPoint(),this.items.length>0&&(this.isInitialized=!0,this.setupIconDistribution(),console.log("MobileNavCore: Навигация инициализирована")),this.setupIconDistribution()}calculateCenterPoint(){this.centerPoint=this.container?this.container.offsetWidth/2:0}hideNavigation(){const e=document.querySelector(".mb-navigation");e&&e.classList.add("mb-nav-hidden")}showNavigation(){const e=document.querySelector(".mb-navigation");e&&e.classList.remove("mb-nav-hidden")}convertIconToBackButton(e){var s;if(!this.isInitialized)return console.warn('MobileNavCore: Невозможно преобразовать иконку в кнопку "назад" - ядро не инициализировано'),!1;this.showNavigation(),this.activeIconId=e,this.activeIconId&&this.activeIconId!==e&&this.restoreIcon(this.activeIconId);let t=null;if(t=this.items.find(n=>n.getAttribute("data-icon-id")===e),t||(t=document.getElementById(`nav-icon-${e}`)),t||(t=document.querySelector(`[data-nav-id="${e}"], .mb-icon-wrapper[data-id="${e}"]`)),!t)return console.warn(`⚠️ MobileNavCore: Иконка с ID ${e} не найдена, невозможно преобразовать в кнопку "назад"`),!1;const o=t.querySelector("a"),i=t.querySelector(".mb-nav-icon");if(o&&i){console.log(`✅ Преобразование иконки ${e} в кнопку "назад"`),this.originalIcons.has(e)||(this.originalIcons.set(e,{link:o.getAttribute("href"),img:i.getAttribute("src"),text:((s=t.querySelector(".mb-icon-title"))==null?void 0:s.textContent)||"",classes:t.className,linkClasses:o.className,onclick:o.onclick}),console.log("💾 Сохранено оригинальное состояние иконки",e)),o.setAttribute("href","javascript:void(0);"),o.classList.add("mb-nav-back-btn");const n=t.querySelector(".mb-icon-title");n&&(n.textContent="Назад");const l="/images/icons/arrow-left.svg",a=new Image;return a.onload=()=>{i.setAttribute("src",l),t.classList.add("back-button-active"),console.log('🔙 Установлена иконка "назад"')},a.onerror=()=>{i.style.backgroundImage="none",i.textContent="←",i.style.fontSize="24px",i.style.textAlign="center",i.style.lineHeight="24px",t.classList.add("back-button-active"),console.log('🔙 Установлен символ "←" вместо иконки')},a.src=l,o._closeModalHandler&&(o.removeEventListener("click",o._closeModalHandler),o.onclick=null),o._closeModalHandler=r=>{if(r.preventDefault(),r.stopPropagation(),console.log('👆 Нажата кнопка "Назад" для закрытия модального окна'),window.modalPanel&&typeof window.modalPanel.closeModal=="function")console.log("✅ Закрываем через window.modalPanel.closeModal()"),window.modalPanel.closeModal();else if(window.closeModalPanel)console.log("✅ Закрываем через window.closeModalPanel()"),window.closeModalPanel();else{console.log("⚠️ Не найден метод для закрытия модального окна");const p=document.querySelector(".modal-panel.show, .modal-panel.fade.show");p&&(console.log("✅ Закрываем модальное окно напрямую через classList"),p.classList.remove("show"),setTimeout(()=>{p.parentNode&&p.classList.add("d-none")},300)),document.dispatchEvent(new CustomEvent("modal.close.requested",{bubbles:!0,cancelable:!0}))}return setTimeout(()=>{this.restoreIcon(e)},100),!1},o.addEventListener("click",o._closeModalHandler),o.onclick=o._closeModalHandler,o.addEventListener("touchend",o._closeModalHandler),this.activeIconId=e,!0}return!1}restoreIcon(e){if(!this.isInitialized)return console.warn("MobileNavCore: Невозможно восстановить иконку - ядро не инициализировано"),!1;if(!this.originalIcons.has(e))return console.log(`⚠️ Нет сохраненных данных для восстановления иконки ${e}`),!1;console.log(`🔄 Восстанавливаем оригинальную иконку ${e}`);let t=null;if(t=this.items.find(n=>n.getAttribute("data-icon-id")===e),t||(t=document.getElementById(`nav-icon-${e}`)),t||(t=document.querySelector(`[data-nav-id="${e}"], .mb-icon-wrapper[data-id="${e}"]`)),!t)return console.warn(`⚠️ MobileNavCore: Иконка с ID ${e} для восстановления не найдена`),!1;const o=this.originalIcons.get(e),i=t.querySelector("a"),s=t.querySelector(".mb-nav-icon");if(i&&s&&o){if(i._closeModalHandler&&(i.removeEventListener("click",i._closeModalHandler),i.removeEventListener("touchend",i._closeModalHandler),delete i._closeModalHandler),i.setAttribute("href",o.link),i.className=o.linkClasses||"",s.setAttribute("src",o.img),o.text!==void 0){const n=t.querySelector(".mb-icon-title");n&&(n.textContent=o.text)}return o.onclick&&(i.onclick=o.onclick),s.style.backgroundImage="",s.style.fontSize="",s.style.textAlign="",s.style.lineHeight="",s.textContent="",t.className=o.classes,t.classList.remove("back-button-active"),i.onclick=null,console.log(`✅ Иконка ${e} успешно восстановлена`),this.originalIcons.delete(e),this.activeIconId===e&&(this.activeIconId=null),!0}return!1}checkEditorPage(){const e=window.location.pathname;(e.includes("/templates/editor")||e.includes("/client/templates/editor"))&&this.ensureNavigationVisible()}ensureNavigationVisible(){const e=document.querySelector(".mb-navigation");e&&(e.classList.remove("mb-nav-hidden"),this.ensureNavigationAccessible())}ensureNavigationAccessible(){const e=document.querySelector(".mb-navigation"),t=this.container,o=this.iconsContainer;e&&(e.classList.remove("popup-interaction-blocked"),e.style.pointerEvents=""),t&&(t.style.pointerEvents="",t.classList.remove("pointer-events-blocked")),o&&(o.style.pointerEvents="",o.classList.remove("pointer-events-blocked")),this.items.forEach(i=>{i.style.pointerEvents="",i.classList.remove("pointer-events-blocked")}),console.log("MobileNavCore: Навигация разблокирована для взаимодействия")}blockNavigationInteraction(){const e=document.querySelector(".mb-navigation");e&&e.classList.add("popup-interaction-blocked"),console.log("MobileNavCore: Взаимодействие с навигацией заблокировано")}initModalEventHandlers(){document.addEventListener("modal.opened",e=>{console.log("MobileNavCore: Модальное окно открыто, обеспечиваем доступность навигации"),setTimeout(()=>{this.ensureNavigationAccessible()},100)}),document.addEventListener("modal.closed",e=>{console.log("MobileNavCore: Модальное окно закрыто, восстанавливаем навигацию"),setTimeout(()=>{this.ensureNavigationAccessible()},100)}),document.addEventListener("modal.beforeOpen",e=>{this.ensureNavigationAccessible()}),document.addEventListener("modal.afterClose",e=>{this.ensureNavigationAccessible()})}setupIconDistribution(){if(!this.iconsContainer||!this.items.length)return;const e=this.items.length;this.iconsContainer.setAttribute("data-icon-count",e.toString()),this.iconsContainer.classList.remove("icons-2","icons-3","icons-4","icons-5"),e<=5&&this.iconsContainer.classList.add(`icons-${e}`),this.items.forEach((t,o)=>{const i=100/e;t.style.flex=`0 0 ${i}%`,t.style.maxWidth=`${i}%`}),console.log(`MobileNavCore: Настроено распределение для ${e} иконок`)}}class v{constructor(e,t,o){this.core=e,this.scroll=t,this.popup=o,this.touchStartX=0,this.touchStartY=0,this.isTouchMoved=!1,this.isLongPress=!1,this.longPressTimer=null,this.longPressDelay=500,this.activeIconId=null,this.preventSystemGestures=this.preventSystemGestures.bind(this),this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.setupEventListeners()}):setTimeout(()=>this.setupEventListeners(),500)}setupEventListeners(){!this.core.isInitialized||!this.core.container||(this.setupModalListeners(),this.setupTouchEvents(),this.setupClickEvents(),this.setupSystemGesturesProtection())}setupModalListeners(){if(document.addEventListener("modal.opened",e=>{var i,s;const t=(i=e.detail)==null?void 0:i.modalId;let o=(s=e.detail)==null?void 0:s.sourceIconId;!o&&t&&this.popup.modalTriggers.has(t)&&(o=this.popup.modalTriggers.get(t).iconId),t&&o&&(this.activeIconId!==o?(this.activeIconId&&this.core.restoreIcon(this.activeIconId),this.activeIconId=o,this.core.convertIconToBackButton(o)):(this.core.restoreIcon(o),this.core.convertIconToBackButton(o)))}),document.addEventListener("modal.closed",e=>{var o;((o=e.detail)==null?void 0:o.modalId)&&this.activeIconId&&(this.core.restoreIcon(this.activeIconId),this.activeIconId=null)}),window.modalPanel&&!window.modalPanel._methodsModified){const e=window.modalPanel.openModal,t=window.modalPanel.closeModal;window.modalPanel.openModal=o=>{const i=e.call(window.modalPanel,o);if(i){let s=null;if(window.modalPanel.modalSources&&window.modalPanel.modalSources.has(o)?s=window.modalPanel.modalSources.get(o):this.popup&&this.popup.modalTriggers.has(o)&&(s=this.popup.modalTriggers.get(o)),s&&s.iconId){const n=new CustomEvent("modal.opened",{detail:{modalId:o,sourceIconId:s.iconId}});document.dispatchEvent(n)}}return i},window.modalPanel.closeModal=(o=!1)=>{var s;const i=(s=window.modalPanel.activeModal)==null?void 0:s.id;if(t.call(window.modalPanel,o),i){const n=new CustomEvent("modal.closed",{detail:{modalId:i}});document.dispatchEvent(n)}},window.modalPanel._methodsModified=!0}}setupTouchEvents(){this.core.container.addEventListener("touchstart",e=>{this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY,this.isTouchMoved=!1;const t=document.elementFromPoint(this.touchStartX,this.touchStartY),o=t?t.closest(".mb-icon-wrapper"):null;o&&(o.classList.add("mb-touch-active"),this.longPressTimer&&clearTimeout(this.longPressTimer),this.longPressTimer=setTimeout(()=>{if(!this.isTouchMoved&&(this.isLongPress=!0,this.handleLongPress(o),this.popup)){const i=o.getAttribute("data-icon-id");this.popup.userHasInteracted=!0,this.popup.swipeTargetElement=o,this.popup.swipeTargetIconId=i}},this.longPressDelay)),(e.target.closest(".mb-navigation")||e.target.closest(".mobile-nav-component"))&&e.preventDefault()},{passive:!1}),this.core.container.addEventListener("touchmove",e=>{const t=e.touches[0].clientX,o=e.touches[0].clientY,i=document.elementFromPoint(t,o),s=i?i.closest(".mb-icon-wrapper"):null,n=t-this.touchStartX,l=o-this.touchStartY;if(!this.isTouchMoved&&l<-30&&Math.abs(l)>Math.abs(n)&&s){this.isTouchMoved=!0;const a=s.getAttribute("data-icon-id");console.log(`⬆️ Свайп вверх детектирован в Events для иконки ${a} - передача в Popup`),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}else this.longPressTimer&&(Math.abs(n)>10||Math.abs(l)>10)&&(this.isTouchMoved=!0,clearTimeout(this.longPressTimer),this.longPressTimer=null,document.querySelectorAll(".mb-touch-active").forEach(a=>{a.classList.remove("mb-touch-active")}));(e.target.closest(".mb-navigation")||e.target.closest(".mobile-nav-component"))&&e.preventDefault()},{passive:!1}),this.core.container.addEventListener("touchend",e=>{if(document.querySelectorAll(".mb-touch-active").forEach(t=>{t.classList.remove("mb-touch-active")}),this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),!this.isLongPress&&!this.isTouchMoved){const t=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY,i=document.elementFromPoint(t,o),s=i?i.closest(".mb-icon-wrapper"):null;if(s){const n=s.getAttribute("data-icon-id");if(console.log(`👆 Тап на иконке ${n}`),n&&this.popup&&this.popup.popupConfigs&&this.popup.popupConfigs[n]&&console.log(`ℹ️ Для иконки ${n} доступно всплывающее меню по свайпу вверх`),this.popup&&this.popup.areClicksBlocked&&this.popup.areClicksBlocked()){console.log(`🚫 Клики заблокированы после свайпа, пропускаем обработку клика для ${n}`);return}const l=s.querySelector("a[href]");if(l&&l.getAttribute("href")!=="#"&&l.getAttribute("href")!=="javascript:void(0);"){const a=l.getAttribute("href");console.log(`🔗 Прямой переход по ссылке для иконки: ${n} -> ${a}`),window.location.href=a;return}setTimeout(()=>{const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window,clientX:t,clientY:o});s.dispatchEvent(a)},0)}}this.isLongPress=!1,this.isTouchMoved=!1},{passive:!0})}setupClickEvents(){document.querySelectorAll(".mb-icon-wrapper").forEach(t=>{const o=t.getAttribute("data-icon-id"),i=t.getAttribute("data-modal-target"),s=t.getAttribute("data-modal")==="true";i&&o&&s&&this.popup.modalTriggers.set(i,{element:t,iconId:o}),t.addEventListener("click",n=>{if(s&&i)n.preventDefault(),n.stopPropagation(),o==="qr-scanner"&&window.openQrScannerModal?window.openQrScannerModal(t):window.modalPanel&&window.modalPanel.openModal(i);else if(this.popup.popupConfigs&&this.popup.popupConfigs[o])if(t.getAttribute("data-popup-on-click")==="true")n.preventDefault(),this.popup.showPopup(o);else{const a=t.querySelector("a[href]");if(a&&a.getAttribute("href")!=="#"&&a.getAttribute("href")!=="javascript:void(0);"){window.location.href=a.getAttribute("href");return}}else if(o==="save")n.preventDefault(),window.location.href.includes("templates/editor")||window.location.href.includes("templates/editor")?typeof window.saveTemplateForm=="function"&&window.saveTemplateForm():window.location.href.includes("media/editor")&&typeof window.processMedia=="function"&&window.processMedia();else{const l=t.querySelector("a[href]");if(l&&l.getAttribute("href")!=="#"&&l.getAttribute("href")!=="javascript:void(0);"){window.location.href=l.getAttribute("href");return}}})})}handleLongPress(e){const t=e.getAttribute("data-icon-id");if(t){if(e.classList.add("mb-long-press"),navigator.vibrate)try{navigator.vibrate(50)}catch{}setTimeout(()=>{this.popup.showPopup(t),e.classList.remove("mb-long-press")},300)}}setupSystemGesturesProtection(){if(this.core.container){document.documentElement.style.overscrollBehaviorX="none",document.body.style.overscrollBehaviorX="none",document.documentElement.style.overscrollBehaviorY="none",document.body.style.overscrollBehaviorY="contain",this.core.container.style.overscrollBehaviorX="none",this.core.container.style.touchAction="pan-y",document.documentElement.style.webkitOverflowScrolling="touch",document.body.style.webkitOverflowScrolling="touch";const e=document.createElement("style");e.innerHTML=`
                .mb-navigation, .mobile-nav-component {
                    touch-action: pan-y;
                    -ms-touch-action: pan-y;
                    -webkit-touch-callout: none;
                    -webkit-user-select: none;
                    -moz-user-select: none;
                    -ms-user-select: none;
                    user-select: none;
                }
                
                .edge-detector {
                    position: fixed;
                    top: 0;
                    height: 100vh;
                    width: 20px;
                    z-index: 9999;
                    background: transparent;
                }
                
                .edge-detector-left {
                    left: 0;
                }
                
                .edge-detector-right {
                    right: 0;
                }
            `,document.head.appendChild(e),document.addEventListener("touchstart",this.preventSystemGestures,{passive:!1}),document.addEventListener("touchmove",this.preventSystemGestures,{passive:!1}),"ontouchstart"in window&&this.addEdgeDetectors(),document.querySelectorAll(".mb-icon-wrapper, .mb-navigation, .mobile-nav-component").forEach(t=>{t.addEventListener("contextmenu",o=>(o.preventDefault(),!1))}),window.addEventListener("popstate",t=>{this.popup&&this.popup.isPopupOpen&&(this.popup.hidePopup(),t.preventDefault())}),window.addEventListener("popstate",function(t){if(document.querySelector(".modal-panel.show")||document.querySelector(".mb-popup-container.visible"))return history.pushState(null,null,window.location.pathname),t.preventDefault(),!1})}}addEdgeDetectors(){document.querySelectorAll(".edge-detector").forEach(o=>{o.remove()});const e=document.createElement("div");e.className="edge-detector edge-detector-left",document.body.appendChild(e);const t=document.createElement("div");t.className="edge-detector edge-detector-right",document.body.appendChild(t),[e,t].forEach(o=>{o.addEventListener("touchstart",i=>(console.log("Блокировка системного жеста на краю экрана"),i.preventDefault(),i.stopPropagation(),!1),{passive:!1}),o.addEventListener("touchmove",i=>(i.preventDefault(),i.stopPropagation(),!1),{passive:!1}),o.addEventListener("touchend",i=>(i.preventDefault(),i.stopPropagation(),!1),{passive:!1}),o.addEventListener("touchstart",this.preventDefaultForEvent,{passive:!1}),o.addEventListener("touchmove",this.preventDefaultForEvent,{passive:!1})}),console.log("✅ Детекторы краев экрана добавлены для защиты от системных жестов")}preventSystemGestures(e){const t=e.type==="touchstart"||e.type==="touchmove"?e.touches[0].clientX:0,o=e.type==="touchstart"||e.type==="touchmove"?e.touches[0].clientY:0,i=window.innerWidth;if(t<40||t>i-40)if(e.type==="touchmove"&&e.touches.length===1){const s=Math.abs(t-this._lastTouchX),n=Math.abs(o-this._lastTouchY);s>n&&(console.log("🚫 Блокировка системного жеста на краю экрана"),e.preventDefault(),e.stopPropagation())}else e.type==="touchstart"&&(this._lastTouchX=t,this._lastTouchY=e.touches[0].clientY,e.preventDefault())}preventDefaultForEvent(e){return e.preventDefault(),e.stopPropagation(),!1}}class b{constructor(e){this.core=e,this.isScrolling=!1,this.scrollTimeout=null,this.animationFrame=null,this.isCentering=!1,this.centeringQueue=[],this.lastDebounceTime=0,this.debounceThreshold=150,this.lastScrollLeft=0,this.scrollDirection=0,this.debounceTimeout=null,this.lastPageScroll=0,this.pageScrollTimeout=null,this.pageScrollThreshold=5,this.hideNavigationTimeout=null,this.isNavigationHidden=!1,this.lastUserActionTime=Date.now(),this.inactivityTimeout=null,this.inactivityThreshold=2e3,this.scrollVelocity=0,this.lastScrollTime=Date.now(),this.scrollHistory=[],this.isScrollingDown=!1,this.isScrollingUp=!1,this.touchStartY=null,this.touchStartTime=null,this.inertiaEnabled=!0,this.inertiaFactor=.92,this.inertiaThreshold=.5,this.momentumValue=0,this.rafId=null,this.userHasInteracted=!1,this.initUserInteractionTracking(),this.lastScrollTime=0,this.setupScrollTimeTracking()}setupScrollTimeTracking(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.setupScrollListener()}):setTimeout(()=>this.setupScrollListener(),100)}setupScrollListener(){this.core&&this.core.container?this.core.container.addEventListener("scroll",()=>{this.lastScrollTime=Date.now()},{passive:!0}):setTimeout(()=>this.setupScrollListener(),500)}applyInertia(e){if(!this.inertiaEnabled||Math.abs(e)<this.inertiaThreshold)return;this.momentumValue=e*15,this.rafId&&cancelAnimationFrame(this.rafId);const t=()=>{this.core.container.scrollLeft+=this.momentumValue,this.momentumValue*=this.inertiaFactor,Math.abs(this.momentumValue)>this.inertiaThreshold?this.rafId=requestAnimationFrame(t):this.rafId=null};this.rafId=requestAnimationFrame(t)}getMaxScrollLeft(){const e=this.core.container.offsetWidth,t=this.core.iconsContainer.scrollWidth;return Math.max(0,t-e)}setupPageScrollListener(){let e=!1;const t=()=>{e||(requestAnimationFrame(()=>{this.handlePageScroll(),e=!1}),e=!0)};window.addEventListener("scroll",t,{passive:!0}),document.addEventListener("touchstart",o=>{this.handleTouchStart(o)},{passive:!0}),document.addEventListener("touchmove",o=>{this.handleTouchMove(o)},{passive:!0}),document.addEventListener("touchend",()=>{this.handleTouchEnd()},{passive:!0}),this.setupTouchListeners()}setupTouchListeners(){let e=null,t=null,o=null,i=null;const s=(n,l)=>{let a;return function(){const r=arguments,p=this;a||(n.apply(p,r),a=!0,setTimeout(()=>a=!1,l))}};document.addEventListener("touchstart",n=>{e=n.touches[0].clientY,o=null,i=e},{passive:!0}),document.addEventListener("touchmove",s(n=>{if(e){if(t=n.touches[0].clientY,i!==null){const l=e-t;Math.abs(l)>15&&(l<0&&o!=="down"?(o="down",this.isInExcludedPath()||this.hideNavigation()):l>15&&o!=="up"&&(o="up",this.showNavigation()))}i=t}},100),{passive:!0}),document.addEventListener("touchend",()=>{e=null,t=null,o=null,i=null},{passive:!0})}handlePageScroll(){if(!document.querySelector(".mb-navigation"))return;this.lastUserActionTime=Date.now();const t=window.pageYOffset||document.documentElement.scrollTop,o=Date.now();if(this.pageScrollTimeout&&clearTimeout(this.pageScrollTimeout),this.inactivityTimeout&&clearTimeout(this.inactivityTimeout),this.isInExcludedPath())return;const i=t-this.lastPageScroll,s=o-this.lastScrollTime,n=Math.abs(i)/s;this.scrollHistory.push({delta:i,time:o,speed:n}),this.scrollHistory.length>5&&this.scrollHistory.shift(),this.scrollHistory.reduce((a,r)=>a+r.speed,0)/this.scrollHistory.length,Math.abs(i)>this.pageScrollThreshold&&(i>0&&t>30?this.hideNavigation():i<0&&this.showNavigation()),this.pageScrollTimeout=setTimeout(()=>{(Date.now()-this.lastUserActionTime>=this.inactivityThreshold||t<100)&&this.showNavigation()},this.inactivityThreshold),this.setupInactivityDetection(),this.lastPageScroll=t,this.lastScrollTime=o}setupInactivityDetection(){this.inactivityTimeout&&clearTimeout(this.inactivityTimeout),this.inactivityTimeout=setTimeout(()=>{this.isNavigationHidden&&this.showNavigation()},this.inactivityThreshold)}hideNavigation(){const e=document.querySelector(".mb-navigation");if(!(!e||this.isNavigationHidden)){if(this.isInExcludedPath()){console.log("🚫 Скрытие навигации пропущено на странице редактора");return}console.log("⬇️ Скрываем навигацию при скролле вниз"),requestAnimationFrame(()=>{e.classList.add("mb-nav-hidden"),this.isNavigationHidden=!0,this.lastUserActionTime=Date.now(),this.hideNavigationTimeout&&(clearTimeout(this.hideNavigationTimeout),this.hideNavigationTimeout=null),setTimeout(()=>{this.setupInactivityDetection()},100),console.log("✅ Навигационная панель скрыта при скролле вниз")})}}showNavigation(){const e=document.querySelector(".mb-navigation");!e||!this.isNavigationHidden||(console.log("⬆️ Показываем навигацию при скролле вверх"),this.hideNavigationTimeout&&(clearTimeout(this.hideNavigationTimeout),this.hideNavigationTimeout=null),this.canUseVibrateAPI()&&navigator.vibrate(5),requestAnimationFrame(()=>{setTimeout(()=>{e.classList.remove("mb-nav-hidden"),this.isNavigationHidden=!1,this.lastUserActionTime=Date.now(),this.inactivityTimeout&&(clearTimeout(this.inactivityTimeout),this.inactivityTimeout=null),this.setupInactivityDetection(),console.log("✅ Навигационная панель показана при скролле вверх")},50)}))}registerUserActivity(){this.lastUserActionTime=Date.now(),this.setupInactivityDetection()}setupUserActivityListeners(){["touchstart","touchmove","mousemove","click","keydown","wheel"].forEach(t=>{document.addEventListener(t,()=>{this.registerUserActivity()},{passive:!0})})}canUseVibrateAPI(){return navigator.vibrate&&this.userHasInteracted&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches}initUserInteractionTracking(){const e=["click","touchstart","touchmove","mousedown","keydown"],t=()=>{this.userHasInteracted=!0,e.forEach(o=>{document.removeEventListener(o,t,{passive:!0})})};e.forEach(o=>{document.addEventListener(o,t,{passive:!0})})}blockHorizontalScroll(){console.log("📱 MobileNavScroll: Горизонтальный скролл отключен (фиксированная раскладка)")}unblockHorizontalScroll(){console.log("📱 MobileNavScroll: Горизонтальный скролл отключен (фиксированная раскладка)")}isInExcludedPath(){const e=window.location.pathname;return e.includes("/templates/editor")||e.includes("/client/templates/editor")||e.includes("/client/templates/editor")||e.includes("/admin/")}handleTouchStart(e){this.touchStartY=e.touches[0].clientY,this.touchStartTime=Date.now(),this.isScrollingDown=!1,this.isScrollingUp=!1}handleTouchMove(e){if(!this.touchStartY)return;const t=e.touches[0].clientY,o=this.touchStartY-t,i=Date.now();this.scrollVelocity=o/(i-this.touchStartTime),Math.abs(o)>10&&(o>0?(this.isScrollingDown=!0,this.isScrollingUp=!1,this.isInExcludedPath()||this.hideNavigation()):(this.isScrollingUp=!0,this.isScrollingDown=!1,this.showNavigation()))}handleTouchEnd(){this.touchStartY=null,this.touchStartTime=null,this.scrollVelocity=0,setTimeout(()=>{this.isScrollingDown=!1,this.isScrollingUp=!1},100)}}class w{constructor(e){this.core=e,this.isPopupOpen=!1,this.currentPopupConfig=null,this.popupContainer=null,this.backdrop=null,this.swipeStartY=0,this.swipeStartX=0,this.isSwipeDetected=!1,this.minSwipeDistance=50,this.isUpSwipeInProgress=!1,this.popupConfigs={},this.userHasInteracted=!1,this.swipeTargetElement=null,this.swipeTargetIconId=null,this.modalTriggers=new Map,this.originalBodyOverflow="",this.originalBodyPosition="",this.scrollY=0,this.isClicksBlocked=!1,this.checkAndShowHintIfNeeded=this.checkAndShowHintIfNeeded.bind(this),this.showSwipeHint=this.showSwipeHint.bind(this),this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.delayedInit()}):this.delayedInit()}delayedInit(){setTimeout(()=>{console.log("🎪 MobileNavPopup: Начинаем отложенную инициализацию...");try{this.createPopupElements(),console.log("✅ Popup элементы созданы"),this.loadPopupConfigsFromHtml(),console.log("✅ Конфигурации загружены"),this.setupSwipeDetection(),console.log("✅ Обнаружение свайпов настроено"),this.initModalSystemIntegration(),console.log("✅ Интеграция с модальной системой настроена"),console.log("🎪 MobileNavPopup: Инициализация завершена успешно"),this.validateInitialization()}catch(e){console.error("❌ Ошибка при инициализации MobileNavPopup:",e),setTimeout(()=>{console.log("🔄 Попытка повторной инициализации..."),this.delayedInit()},1e3)}},500)}validateInitialization(){const e=[];return this.popupContainer||e.push("Popup контейнер не создан"),this.backdrop||e.push("Backdrop не создан"),(!this.popupConfigs||Object.keys(this.popupConfigs).length===0)&&e.push("Конфигурации не загружены"),this.core.container||e.push("Контейнер навигации не найден"),e.length>0?(console.warn("⚠️ Обнаружены проблемы при инициализации:",e),!1):(console.log("✅ Валидация инициализации прошла успешно"),!0)}loadPopupConfigsFromHtml(){console.log("🔍 Начинаем загрузку конфигураций popup из HTML...");const e=document.getElementById("mobile-nav-popup-configs");if(!e){console.warn("❌ Элемент #mobile-nav-popup-configs не найден, используются запасные конфигурации"),this.popupConfigs=this.getFallbackPopupConfigs(),console.log("📋 Загружены запасные конфигурации меню:",Object.keys(this.popupConfigs));return}console.log("✅ Элемент #mobile-nav-popup-configs найден"),console.log("📄 HTML содержимое элемента:",e.innerHTML.substring(0,200)+"...");const t=e.querySelectorAll("[data-popup-config]");if(console.log(`🔍 Найдено ${t.length} секций конфигураций`),t.length===0){console.warn("❌ Секции конфигурации не найдены внутри #mobile-nav-popup-configs, используются запасные конфигурации"),this.popupConfigs=this.getFallbackPopupConfigs();return}t.forEach(o=>{const i=o.getAttribute("data-popup-config");console.log(`📝 Обрабатываем конфигурацию: ${i}`);const s=o.querySelector(".popup-header, .popup-config-title"),n=s?s.textContent.trim():i,l=o.querySelectorAll(".popup-item");console.log(`  └─ Найдено ${l.length} элементов меню`);const a=[];l.forEach((r,p)=>{const h=r.getAttribute("data-icon"),m=r.getAttribute("data-href")||"#",d=r.getAttribute("data-title"),u=r.getAttribute("data-modal")==="true",g=r.getAttribute("data-modal-target");console.log(`    └─ Элемент ${p+1}: ${d} (${u?"модальное":"ссылка"})`),a.push({icon:h,href:m,title:d,isModal:u,modalId:g})}),a.length>0?(this.popupConfigs[i]={title:n,items:a},console.log(`✅ Загружена конфигурация меню для "${i}" с ${a.length} элементами`)):console.warn(`⚠️ Пустая конфигурация для меню "${i}"`)}),Object.keys(this.popupConfigs).length===0&&(console.warn("❌ Не загружено ни одной конфигурации, используются запасные конфигурации"),this.popupConfigs=this.getFallbackPopupConfigs()),console.log("🎯 Финальные загруженные конфигурации:",Object.keys(this.popupConfigs))}getFallbackPopupConfigs(){return{home:{title:"Главная",items:[{icon:"newspaper.svg",href:"/news",isModal:!1,title:"Новости"},{icon:"calendar.svg",href:"/events",isModal:!1,title:"События"},{icon:"info-circle.svg",href:"/about",isModal:!1,title:"О нас"}]},profile:{title:"Профиль",items:[{icon:"gear.svg",href:"/profile/settings",isModal:!1,title:"Настройки"},{icon:"clock-history.svg",href:"/user/templates",isModal:!1,title:"История"},{icon:"heart.svg",href:"/user/favorites",isModal:!1,title:"Избранное"}]},create:{title:"Создать",items:[{icon:"folder-plus.svg",href:"/client/projects",isModal:!1,title:"Проекты"},{icon:"image.svg",href:"/client/images",isModal:!1,title:"Изображения"}]},games:{title:"Развлечения",items:[{icon:"puzzle.svg",href:"/games/puzzle",isModal:!1,title:"Пазлы"},{icon:"controller.svg",href:"/games/arcade",isModal:!1,title:"Аркады"},{icon:"trophy.svg",href:"/games/tournaments",isModal:!1,title:"Турниры"}]},email:{title:"Почта",items:[{icon:"inbox.svg",href:"/email/inbox",isModal:!1,title:"Входящие"},{icon:"send.svg",href:"/email/sent",isModal:!1,title:"Отправленные"},{icon:"pencil.svg",href:"/email/compose",isModal:!1,title:"Написать"}]},admin:{title:"Администрирование",items:[{icon:"people.svg",href:"/admin/users",isModal:!1,title:"Пользователи"},{icon:"bar-chart.svg",href:"/admin/statistics",isModal:!1,title:"Статистика"},{icon:"gear.svg",href:"/admin/settings",isModal:!1,title:"Настройки"}]},"qr-scanner":{title:"QR Сканер",items:[{icon:"qr-code.svg",href:"#",isModal:!0,modalId:"qr-scanner-modal",title:"Сканировать"},{icon:"camera.svg",href:"#",isModal:!0,modalId:"camera-modal",title:"Камера"},{icon:"image.svg",href:"/qr/history",isModal:!1,title:"История"}]}}}createPopupElements(){console.log("🏗️ Создаем элементы popup..."),this.backdrop=document.createElement("div"),this.backdrop.className="mb-popup-backdrop",console.log("✅ Backdrop создан:",this.backdrop),this.popupContainer=document.createElement("div"),this.popupContainer.className="mb-popup-container mb-popup-swipeable",console.log("✅ Popup контейнер создан:",this.popupContainer);const e=document.createElement("div");e.className="mb-swipe-indicator",this.popupContainer.appendChild(e),document.body.appendChild(this.backdrop),document.body.appendChild(this.popupContainer),console.log("✅ Элементы добавлены в DOM"),console.log("🔍 Backdrop в DOM:",document.body.contains(this.backdrop)),console.log("🔍 Popup в DOM:",document.body.contains(this.popupContainer)),this.backdrop.addEventListener("click",()=>{console.log("👆 Клик по backdrop, закрываем popup"),this.closePopup()}),this.popupContainer.addEventListener("touchstart",t=>{this.swipeStartY=t.touches[0].clientY}),this.popupContainer.addEventListener("touchend",t=>{t.changedTouches[0].clientY-this.swipeStartY>this.minSwipeDistance&&(console.log("👆 Свайп вниз обнаружен, закрываем popup"),this.closePopup())}),this.ensureAnimationStyles(),console.log("🎪 MobileNavPopup: Элементы popup созданы и настроены")}setupSwipeDetection(){if(!this.core.container){const e=document.getElementById("nav-scroll-container");if(e)this.core.container=e;else return}this.core.container.addEventListener("touchstart",e=>{this.userHasInteracted=!0;const t=e.touches[0],o=t.clientX,i=t.clientY,s=Array.from(this.core.iconsContainer.querySelectorAll(".mb-icon-wrapper"));let n=null;for(const l of s){const a=l.getBoundingClientRect();if(o>=a.left&&o<=a.right&&i>=a.top&&i<=a.bottom){n=l;break}}if(n){if(this.swipeTargetElement=n,this.swipeTargetIconId=n.getAttribute("data-icon-id"),this.swipeStartY=i,this.swipeStartX=o,this.isSwipeDetected=!1,this.isUpSwipeInProgress=!1,this.swipeTargetIconId&&this.popupConfigs[this.swipeTargetIconId]){const l=this,a=this.swipeTargetElement;setTimeout(()=>{l&&typeof l.checkAndShowHintIfNeeded=="function"?l.checkAndShowHintIfNeeded(a):console.warn("⚠️ Метод checkAndShowHintIfNeeded не найден в MobileNavPopup или контекст потерян")},0)}this.swipeTargetElement.classList.add("mb-touch-active")}else this.swipeTargetElement=null,this.swipeTargetIconId=null,this.swipeStartY=0,this.swipeStartX=0},{passive:!0}),this.core.container.addEventListener("touchmove",e=>{if(!this.swipeTargetElement||this.swipeStartY===0)return;const t=e.touches[0],o=this.swipeStartY-t.clientY,i=Math.abs(t.clientX-this.swipeStartX);if(o>15&&i<75){if(this.isUpSwipeInProgress=!0,console.log(`📏 Свайп обнаружен: ΔY=${o.toFixed(1)}, ΔX=${i.toFixed(1)}, IconID=${this.swipeTargetIconId}`),this.swipeTargetElement.classList.contains("swiping-up")||(this.swipeTargetElement.classList.add("swiping-up"),console.log("⬆️ Добавлен класс swiping-up для визуальной обратной связи")),o>20&&(this.core.container&&(this.core.container.style.overflowX="hidden"),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()),o>this.minSwipeDistance&&(this.isSwipeDetected=!0,!this.swipeTargetElement.hasAttribute("data-vibrated")&&navigator.vibrate&&this.userHasInteracted&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches))try{navigator.vibrate(20),this.swipeTargetElement.setAttribute("data-vibrated","true")}catch{}}else i>30&&(this.isUpSwipeInProgress=!1,this.isSwipeDetected=!1,this.swipeTargetElement.classList.remove("swiping-up"))},{passive:!1}),this.core.container.addEventListener("touchend",e=>{if(this.core.container&&(this.core.container.style.overflowX="auto"),this.swipeTargetElement&&(this.swipeTargetElement.classList.remove("mb-touch-active","swiping-up"),this.swipeTargetElement.removeAttribute("data-vibrated")),this.isSwipeDetected&&this.swipeTargetIconId){if(console.log(`🔺 Popup: Свайп вверх обнаружен на иконке: ${this.swipeTargetIconId}`),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),document.querySelector(".modal.show")!==null){console.log("🚫 Popup: Модальное окно открыто, пропускаем показ popup"),this.resetSwipeState();return}this.swipeTargetElement&&this.preventClicksOnElement(this.swipeTargetElement),this.showPopup(this.swipeTargetIconId)}this.resetSwipeState()})}showSwipeHint(e){if(localStorage.getItem("mobile-nav-swipe-hint-seen"))return;let o=document.querySelector(".mb-swipe-hint");o||(o=document.createElement("div"),o.className="mb-swipe-hint",o.innerHTML="⬆️ Проведите вверх для открытия меню",document.body.appendChild(o)),o.classList.add("show"),setTimeout(()=>{o.classList.remove("show"),localStorage.setItem("mobile-nav-swipe-hint-seen","true")},3e3)}checkAndShowHintIfNeeded(e){const t=localStorage.getItem("mobile-nav-swipe-hint-seen"),o=localStorage.getItem("mobile-nav-user-interacted");!t&&!o&&(localStorage.setItem("mobile-nav-user-interacted","true"),setTimeout(()=>{this.showSwipeHint(e)},1e3))}resetSwipeState(){this.swipeTargetElement=null,this.swipeStartY=0,this.swipeStartX=0,this.isSwipeDetected=!1,this.isUpSwipeInProgress=!1,this.swipeTargetIconId=null}getCenteredItem(){return null}showPopup(e){console.log("🔺 MobileNavPopup: Попытка показать popup для иконки:",e),console.log("🔍 Доступные конфигурации:",Object.keys(this.popupConfigs));const t=this.popupConfigs[e];if(!t){console.error("❌ Конфигурация для иконки не найдена:",e);return}if(this.isPopupOpen){console.warn("⚠️ Popup уже открыт, пропускаем");return}if(document.querySelector(".modal.show")!==null){console.log("🚫 Popup: Модальное окно открыто, не показываем popup для",e);return}if(console.log("✅ Показываем popup для иконки:",e),console.log("📋 Конфигурация popup:",t),this.currentPopupConfig=t,this.isPopupOpen=!0,this.blockBodyScroll(),this.currentIconId=e,this.renderPopupContent(t,e),console.log("🎭 Применяем стили видимости..."),this.backdrop.classList.add("show","visible"),this.popupContainer.classList.add("show","visible"),requestAnimationFrame(()=>{this.backdrop.style.opacity="1",this.backdrop.style.visibility="visible",this.popupContainer.style.opacity="1",this.popupContainer.style.visibility="visible",this.popupContainer.style.transform="translateX(-50%) translateY(0)",console.log("🎭 Стили применены. Popup должен быть виден."),console.log("🔍 Backdrop стили:",{opacity:this.backdrop.style.opacity,visibility:this.backdrop.style.visibility,classList:Array.from(this.backdrop.classList)}),console.log("🔍 Popup стили:",{opacity:this.popupContainer.style.opacity,visibility:this.popupContainer.style.visibility,transform:this.popupContainer.style.transform,classList:Array.from(this.popupContainer.classList)})}),navigator.vibrate&&this.userHasInteracted&&!window.matchMedia("(prefers-reduced-motion: reduce)").matches)try{navigator.vibrate(50),console.log("📳 Вибрация активирована")}catch(i){console.log("❌ Ошибка вибрации:",i)}}renderPopupContent(e,t){this.popupContainer.className="mb-popup-container mb-popup-swipeable",this.popupContainer.classList.add(`popup-for-${t}`),this.getIconTitle(t),this.popupContainer.innerHTML=`
            <div class="mb-swipe-indicator"></div>
           
            <div class="mb-popup-grid">
                ${e.items.map((o,i)=>`
                        <a ${o.isModal?`href="javascript:void(0);" data-modal="true" data-modal-target="${o.modalId}" class="mb-popup-item modal-trigger no-spinner"`:`href="${o.href}" class="mb-popup-item"`} style="animation-delay: ${i*.1}s;">
                            <img src="/images/icons/${o.icon}" 
                                alt="${o.title}" 
                                title="${o.title}"
                                onerror="this.src='/images/icons/placeholder.svg'; this.classList.add('fallback-icon');"
                                onload="this.classList.add('loaded-icon');">
                            <span class="popup-item-title">${o.title}</span>
                        </a>
                    `).join("")}
            </div>
        `,this.ensureAnimationStyles(),this.setupPopupEventListeners()}getIconTitle(e){if(this.popupConfigs[e]&&this.popupConfigs[e].title)return this.popupConfigs[e].title;const t=this.core.iconsContainer.querySelector(`[data-icon-id="${e}"]`);if(t){const o=t.querySelector("img");if(o&&o.alt)return o.alt;const i=t.querySelector("a");if(i&&i.title)return i.title}return e?e.charAt(0).toUpperCase()+e.slice(1):""}setupPopupEventListeners(){this.popupContainer.addEventListener("click",t=>{t.target.closest(".mb-popup-grid")||(t.preventDefault(),this.closePopup())}),this.popupContainer.querySelectorAll(".mb-popup-item").forEach(t=>{t.hasAttribute("data-modal-target")?t.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation();const i=t.getAttribute("data-modal-target");console.log("🎯 Popup: Клик по модальному триггеру",i,"из иконки",this.currentIconId),this.currentIconId&&this.modalTriggers.set(i,{element:this.swipeTargetElement,iconId:this.currentIconId}),this.closePopup(),setTimeout(()=>{window.openModalPanel?(console.log("🚀 Popup: Открываем модальное окно",i),window.openModalPanel(i)):console.error("openModalPanel не доступен")},200)}):t.addEventListener("click",()=>{this.closePopup()})}),this.popupContainer.addEventListener("touchstart",t=>{this.swipeStartY=t.touches[0].clientY},{passive:!0}),this.popupContainer.addEventListener("touchmove",t=>{if(this.swipeStartY===0)return;t.touches[0].clientY-this.swipeStartY>50&&this.closePopup()},{passive:!0})}ensureAnimationStyles(){if(!document.querySelector("#mb-popup-animations")){const e=document.createElement("style");e.id="mb-popup-animations",e.textContent=`
                .mb-popup-item {
                      transform: translateY(20px);
    opacity: 0;
    animation: slideUpFade 0.3s ease forwards;
    display: flex;
    width: 100%;
    flex-direction: row;
    align-items: center;
    gap: 5px;
    align-content: center;
    justify-content: flex-start;
                }
                .popup-item-title {
                   font-size: 16px;
    text-align: center;
    color: #333;
    margin-top: 0;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
                }
                @keyframes slideUpFade {
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
                .mb-popup-item .fallback-icon {
                    opacity: 0.4;
                    filter: grayscale(1);
                }
                .mb-popup-item .loaded-icon {
                    opacity: 1;
                    filter: none;
                }
                .mb-popup-item img {
                    transition: all 0.3s ease;
                    width: 32px;
                    height: 32px;
                }
                
                /* Стили для класса mb-touch-active и swiping-up */
                .mb-icon-wrapper.mb-touch-active {
                    opacity: 0.8;
                    transform: scale(0.95);
                    transition: all 0.2s ease;
                }
                
                .mb-icon-wrapper.swiping-up {
                    transform: scale(0.92);
                }
                
                .mb-icon-wrapper.swiping-up::after {
                    content: '';
                    position: absolute;
                    top: -8px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: 0;
                    height: 0;
                    border-left: 6px solid transparent;
                    border-right: 6px solid transparent;
                    border-bottom: 8px solid rgba(0, 123, 255, 0.6);
                    animation: pulse 1s infinite;
                }
                
                @keyframes pulse {
                    0% { opacity: 0.4; }
                    50% { opacity: 1; }
                    100% { opacity: 0.4; }
                }
                
                /* Стили для заголовка попапа */
                .mb-popup-title {
                    margin: 0;
                    padding: 12px 20px 0;
                    text-align: center;
                    font-weight: 600;
                    font-size: 1rem;
                    color: #333;
                }
                
                /* Стили для кнопки "назад" */
                .mb-icon-wrapper.back-button-active {
                    position: relative;
                    transform: scale(1.05);
                    transition: all 0.3s ease;
                }
                
                .mb-icon-wrapper.back-button-active::after {
                    content: '';
                    position: absolute;
                    bottom: -8px;
                    left: 50%;
                    width: 6px;
                    height: 6px;
                    background-color: #007bff;
                    border-radius: 50%;
                    transform: translateX(-50%);
                    animation: pulse 1.5s infinite;
                }
                
                .mb-icon-wrapper.back-button-active .mb-nav-icon {
                    filter: brightness(1.2);
                    animation: backButtonPulse 2s infinite;
                }
                
                @keyframes backButtonPulse {
                    0%, 100% { transform: scale(1); }
                    50% { transform: scale(1.1); }
                }
            `,document.head.appendChild(e)}}closePopup(){this.isPopupOpen&&(console.log("🔽 Popup: Закрываем popup для иконки",this.currentIconId),this.backdrop.style.opacity="0",this.backdrop.style.visibility="hidden",this.popupContainer.style.opacity="0",this.popupContainer.style.transform="translateX(-50%) translateY(100px)",setTimeout(()=>{this.popupContainer.style.visibility="hidden",this.isPopupOpen=!1,this.currentPopupConfig=null;const e=document.querySelector(".modal-panel.show");!e&&this.currentIconId?(console.log("🔄 Popup: Восстанавливаем иконку",this.currentIconId),window.MobileNavWheelPicker&&window.MobileNavWheelPicker.core&&window.MobileNavWheelPicker.core.restoreIcon(this.currentIconId),this.currentIconId=null):e&&console.log("🔒 Popup: Модальное окно открыто, оставляем иконку как есть"),this.unblockBodyScroll(),this.swipeTargetElement=null,this.swipeTargetIconId=null,this.swipeStartY=0},400))}initModalSystemIntegration(){document.addEventListener("modal.opened",e=>{var o;const t=(o=e.detail)==null?void 0:o.modalId;console.log("🎭 Popup: Получено событие modal.opened для",t),this.resetSwipeState(),console.log("🔄 Popup: Состояние свайпа сброшено при открытии модального окна"),this.isPopupOpen&&(console.log("🔽 Popup: Закрываем popup из-за открытия модального окна"),this.closePopupForModal())}),document.addEventListener("modal.closed",e=>{var o;const t=(o=e.detail)==null?void 0:o.modalId;if(console.log("🎭 Popup: Получено событие modal.closed для",t),this.resetSwipeState(),console.log("🔄 Popup: Состояние свайпа сброшено при закрытии модального окна"),this.modalTriggers.has(t)){const i=this.modalTriggers.get(t);console.log("🔄 Popup: Восстанавливаем иконку из modal.closed",i.iconId),window.MobileNavWheelPicker&&window.MobileNavWheelPicker.core&&window.MobileNavWheelPicker.core.restoreIcon(i.iconId),this.modalTriggers.delete(t),this.currentIconId=null}}),document.addEventListener("modal.afterClose",e=>{var o;const t=(o=e.detail)==null?void 0:o.modalId;console.log("🎭 Popup: Получено событие modal.afterClose для",t),this.resetSwipeState(),console.log("🔄 Popup: Дополнительный сброс состояния свайпа в modal.afterClose")})}closePopupForModal(){this.isPopupOpen&&(console.log("🔽 Popup: Закрываем popup для модального окна"),this.backdrop.style.opacity="0",this.backdrop.style.visibility="hidden",this.popupContainer.style.opacity="0",this.popupContainer.style.transform="translateX(-50%) translateY(100px)",setTimeout(()=>{this.popupContainer.style.visibility="hidden",this.isPopupOpen=!1,this.currentPopupConfig=null,this.unblockBodyScroll(),this.resetSwipeState(),console.log("🔄 Popup: Состояние свайпа сброшено в closePopupForModal")},200))}blockBodyScroll(){const e=window.location.pathname;if(e.includes("/templates/editor")||e.includes("/client/templates/editor")){console.log("Блокировка скролла пропущена на странице редактора");return}this.scrollY=window.pageYOffset||document.documentElement.scrollTop,this.originalBodyOverflow=document.body.style.overflow,this.originalBodyPosition=document.body.style.position,document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${this.scrollY}px`,document.body.style.width="100%",document.body.classList.add("popup-scroll-blocked")}unblockBodyScroll(){document.body.classList.contains("popup-scroll-blocked")&&(document.body.style.overflow=this.originalBodyOverflow,document.body.style.position=this.originalBodyPosition,document.body.style.top="",document.body.style.width="",document.body.classList.remove("popup-scroll-blocked"),this.scrollY>0&&window.scrollTo(0,this.scrollY),this.scrollY=0,this.originalBodyOverflow="",this.originalBodyPosition="")}blockHorizontalScroll(){return this.isUpSwipeInProgress}preventClicksOnElement(e){if(!e)return;console.log("🚫 Popup: Блокируем клики на элементе после свайпа"),this.isClicksBlocked=!0;const t=i=>(console.log("🚫 Popup: Заблокирован клик после свайпа"),i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),!1),o=[e,...e.querySelectorAll("a, button, [data-modal], .modal-trigger")];o.forEach(i=>{i.addEventListener("click",t,{capture:!0,once:!1}),i.addEventListener("touchend",t,{capture:!0,once:!1}),i.addEventListener("mouseup",t,{capture:!0,once:!1})}),setTimeout(()=>{o.forEach(i=>{i.removeEventListener("click",t,{capture:!0}),i.removeEventListener("touchend",t,{capture:!0}),i.removeEventListener("mouseup",t,{capture:!0})}),this.isClicksBlocked=!1,console.log("🔓 Popup: Блокировка кликов снята")},500)}areClicksBlocked(){return this.isClicksBlocked}}typeof window<"u"&&(window.testMobileNavPopup=function(c="home"){console.log("🧪 Тестируем MobileNavPopup для иконки:",c);const e=window.MobileNavWheelPicker;if(!e){console.error("❌ MobileNavWheelPicker не найден в window");return}if(!e.popup){console.error("❌ popup не найден в navigation");return}console.log("📋 Доступные конфигурации:",Object.keys(e.popup.popupConfigs)),console.log("🔍 Состояние popup открыт:",e.popup.isPopupOpen),console.log("🔍 Popup элементы созданы:",{backdrop:!!e.popup.backdrop,container:!!e.popup.popupContainer}),e.popup.popupConfigs[c]?(console.log("✅ Конфигурация найдена, показываем popup"),e.popup.showPopup(c)):(console.error("❌ Конфигурация не найдена для иконки:",c),console.log("💡 Попробуйте:",Object.keys(e.popup.popupConfigs)))},console.log("🧪 Глобальная функция testMobileNavPopup() добавлена"),console.log('💡 Использование: testMobileNavPopup("home")'));class y{constructor(){this.storageKey="mobileNavState",this.routeToIconMap=this.createRouteMapping(),this.storageAvailable=this.checkStorageAvailability()}checkStorageAvailability(){try{const e="__storage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}createRouteMapping(){return{"/":"home","/home":"home","/user/templates":"profile","/profile":"profile","/client/projects":"create","/client/images":"create","/admin/dashboard":"admin","/admin":"admin","/games":"games","/email":"email"}}getIconForCurrentPage(){const e=window.location.pathname;if(this.routeToIconMap[e])return this.routeToIconMap[e];for(const[t,o]of Object.entries(this.routeToIconMap))if(t!=="/"&&e.startsWith(t))return o;return null}getPriorityIcon(){const e=this.getIconForCurrentPage();return e||"home"}clearExpiredData(){if(this.storageAvailable)try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);(!t||!t.timestamp||Date.now()-t.timestamp>24*60*60*1e3)&&localStorage.removeItem(this.storageKey)}}catch(e){console.warn("Ошибка при очистке устаревших данных навигации:",e);try{localStorage.removeItem(this.storageKey)}catch{}}}}class S{constructor(e,t){this.core=e,this.scroll=t}getNavigationInfo(){const e=this.core.container?this.core.container.offsetWidth:0,t=this.core.items?this.core.items.length:0;return{containerWidth:e,iconsCount:t,isFixedLayout:!0,maxIcons:4}}setupVisibilityObserver(){if(!("IntersectionObserver"in window))return;const e={root:null,rootMargin:"0px",threshold:.1},t=new IntersectionObserver(o=>{o.forEach(i=>{i.isIntersecting?i.target.classList.add("mb-visible"):i.target.classList.remove("mb-visible")})},e);document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".mb-icon-wrapper").forEach(i=>t.observe(i))})}}export{f as M,y as a,b,w as c,S as d,v as e};
