const S={state:{currentFile:null,currentFileType:null,imageScale:1,imageX:0,imageY:0,isDragging:!1,lastTouch:null},init(){this.bindEvents(),this.setupDragAndDrop()},bindEvents(){const e=document.getElementById("uploadBtn"),t=document.getElementById("mediaFile");e&&t&&(e.addEventListener("click",()=>t.click()),t.addEventListener("change",this.handleFileSelect.bind(this)));const i=document.getElementById("saveBtn"),l=document.getElementById("resetBtn"),d=document.getElementById("cancelBtn");i&&i.addEventListener("click",this.handleSave.bind(this)),l&&l.addEventListener("click",this.handleReset.bind(this)),d&&d.addEventListener("click",this.handleReset.bind(this));const o=document.getElementById("save-media-btn");o?(console.log("✅ Найдена кнопка save-media-btn, добавляем обработчик"),o.addEventListener("click",this.handleSave.bind(this))):console.log("ℹ️ Кнопка save-media-btn не найдена (возможно, не мобильная версия)");const s=document.getElementById("imageViewport");s&&this.setupImageEditor(s)},setupDragAndDrop(){const e=document.querySelector(".media-editor-container");e&&(["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,this.highlight.bind(this),!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,this.unhighlight.bind(this),!1)}),e.addEventListener("drop",this.handleDrop.bind(this),!1))},preventDefaults(e){e.preventDefault(),e.stopPropagation()},highlight(e){e.currentTarget.classList.add("highlight")},unhighlight(e){e.currentTarget.classList.remove("highlight")},handleDrop(e){const i=e.dataTransfer.files;i.length>0&&this.processFile(i[0])},handleFileSelect(e){const t=e.target.files[0];t&&this.processFile(t)},processFile(e){if(console.log("📁 Обработка файла:",{name:e.name,type:e.type,size:e.size}),!this.validateFile(e))return;this.state.currentFile=e,this.state.currentFileType="image",console.log("✅ Файл валиден, тип:",this.state.currentFileType);const t=new FileReader;t.onload=i=>{console.log("📖 Файл прочитан, показываем редактор"),this.showImageEditor(i.target.result)},t.readAsDataURL(e)},validateFile(e){return["image/jpeg","image/png","image/gif"].includes(e.type)?e.size>52428800?(alert("Файл слишком большой. Максимальный размер: 50MB"),!1):!0:(alert("Неподдерживаемый тип файла. Разрешены только изображения: JPG, PNG, GIF"),!1)},showImageEditor(e){this.hideSection("uploadSection"),this.hideSection("videoEditorSection"),this.showSection("imageEditorSection"),this.showSection("actionButtons");const t=document.getElementById("imagePreview");t&&(t.style.display="block",t.style.maxWidth="none",t.style.maxHeight="none",t.style.position="absolute",t.style.opacity="1",t.src=e,t.onload=()=>{this.resetImageTransform();const i=document.getElementById("imageViewport");if(i){let d,o;window.innerWidth>768?(d=Math.min(window.innerHeight*.8,800),o=d*.5625):(d=window.innerHeight*.8,o=d*.5625),i.style.height=d+"px",i.style.width=o+"px";const s=i.getBoundingClientRect(),h=t.naturalWidth,r=t.naturalHeight;console.log("🖼️ Размеры изображения и viewport:",{imgWidth:h,imgHeight:r,viewportWidth:s.width,viewportHeight:s.height,viewportRatio:.5625}),t.dataset.originalWidth=h,t.dataset.originalHeight=r;const c=h/r,n=s.width/s.height;console.log("📊 Соотношения сторон:",{imageRatio:c,viewportRatio:.5625,viewportActualRatio:n,imgWidth:h,imgHeight:r,viewportWidth:s.width,viewportHeight:s.height}),c>.5625?this.state.imageScale=s.height/r:this.state.imageScale=s.width/h,console.log("📏 Вычисленный масштаб до корректировки:",this.state.imageScale),this.state.imageScale*=1.05;const g=h*this.state.imageScale,y=r*this.state.imageScale;this.state.imageX=(s.width-g)/2,this.state.imageY=(s.height-y)/2,console.log("🎯 Вычисляем центрирование:",{scaledImgWidth:g,scaledImgHeight:y,viewportWidth:s.width,viewportHeight:s.height,imageX:this.state.imageX,imageY:this.state.imageY}),console.log("🎯 Начальная трансформация:",{scale:this.state.imageScale,x:this.state.imageX,y:this.state.imageY}),this.updateImageTransform()}})},showVideoEditor(e){alert("В данной версии поддерживается только редактирование изображений"),this.handleReset()},setupImageEditor(e){let t,i,l,d;e.addEventListener("mousedown",o=>{this.state.isDragging=!0,t=o.clientX,i=o.clientY,l=this.state.imageX,d=this.state.imageY}),document.addEventListener("mousemove",o=>{if(!this.state.isDragging)return;const s=o.clientX-t,h=o.clientY-i;this.state.imageX=l+s,this.state.imageY=d+h,this.updateImageTransform()}),document.addEventListener("mouseup",()=>{this.state.isDragging=!1}),e.addEventListener("wheel",o=>{o.preventDefault();const s=o.deltaY>0?.9:1.1,h=this.state.imageScale;if(this.state.imageScale*=s,this.state.imageScale=Math.max(.1,Math.min(5,this.state.imageScale)),h!==this.state.imageScale){const r=document.getElementById("imagePreview");if(r&&e){const c=e.getBoundingClientRect(),n=r.naturalWidth*this.state.imageScale,g=r.naturalHeight*this.state.imageScale;n<c.width&&(this.state.imageX=(c.width-n)/2),g<c.height&&(this.state.imageY=(c.height-g)/2)}}this.updateImageTransform()}),e.addEventListener("touchstart",o=>{if(o.touches.length===1){this.state.isDragging=!0;const s=o.touches[0];t=s.clientX,i=s.clientY,l=this.state.imageX,d=this.state.imageY}}),e.addEventListener("touchmove",o=>{if(o.preventDefault(),o.touches.length===1&&this.state.isDragging){const s=o.touches[0],h=s.clientX-t,r=s.clientY-i;this.state.imageX=l+h,this.state.imageY=d+r,this.updateImageTransform()}}),e.addEventListener("touchend",()=>{this.state.isDragging=!1})},resetImageTransform(){const e=document.getElementById("imagePreview"),t=document.getElementById("imageViewport");if(e&&t){e.style.display="block",e.style.opacity="1",this.state.imageScale=1;const i=t.getBoundingClientRect();this.state.imageX=(i.width-e.naturalWidth)/2,this.state.imageY=(i.height-e.naturalHeight)/2,console.log("🔄 Сброс трансформации:",{imageScale:this.state.imageScale,imageX:this.state.imageX,imageY:this.state.imageY,viewportWidth:i.width,viewportHeight:i.height,imageWidth:e.naturalWidth,imageHeight:e.naturalHeight})}else this.state.imageScale=1,this.state.imageX=0,this.state.imageY=0;this.updateImageTransform()},updateImageTransform(){const e=document.getElementById("imagePreview"),t=document.getElementById("imageViewport");if(e&&t){let l,d;window.innerWidth>768?(l=Math.min(window.innerHeight*.8,800),d=l*.5625):(l=window.innerHeight*.8,d=l*.5625),t.style.height=l+"px",t.style.width=d+"px",t.style.margin="0 auto",t.style.overflow="hidden",t.classList.add("reels-format"),e.style.transformOrigin="0 0";const o=t.getBoundingClientRect(),s=e.naturalWidth*this.state.imageScale,h=e.naturalHeight*this.state.imageScale;if(this.state.imageX>o.width?this.state.imageX=o.width-50:this.state.imageX+s<0&&(this.state.imageX=-s+50),this.state.imageY>o.height?this.state.imageY=o.height-50:this.state.imageY+h<0&&(this.state.imageY=-h+50),e.style.transform=`translate(${this.state.imageX.toFixed(2)}px, ${this.state.imageY.toFixed(2)}px) scale(${this.state.imageScale.toFixed(4)})`,e.style.display="block",e.style.opacity="1",console.log("🔄 Обновление трансформации:",{scale:this.state.imageScale,x:this.state.imageX,y:this.state.imageY,imgWidth:s,imgHeight:h,viewportWidth:o.width,viewportHeight:o.height}),document.querySelector(".crop-info")&&(document.querySelector(".crop-info").classList.remove("d-none"),document.getElementById("viewport-size").textContent=`${t.clientWidth}×${t.clientHeight}`,document.getElementById("image-size").textContent=`${e.naturalWidth}×${e.naturalHeight}`,document.getElementById("image-scale").textContent=this.state.imageScale.toFixed(2),document.getElementById("image-offset").textContent=`X: ${this.state.imageX.toFixed(0)}px, Y: ${this.state.imageY.toFixed(0)}px`),console.log("🖼️ Обновление трансформации изображения:",{scale:this.state.imageScale,x:this.state.imageX,y:this.state.imageY,viewportWidth:t.clientWidth,viewportHeight:t.clientHeight,imageWidth:e.naturalWidth,imageHeight:e.naturalHeight}),window.innerWidth<=991.98){const n=document.getElementById("actionButtons");n&&n.classList.add("mobile-fixed")}if(t.style.border="2px dashed #f44336",t.style.borderRadius="8px",t.style.boxSizing="border-box",t.style.position="relative",!document.getElementById("crop-frame-help")){const n=document.createElement("div");n.id="crop-frame-help",n.style.position="absolute",n.style.bottom="10px",n.style.left="0",n.style.right="0",n.style.textAlign="center",n.style.backgroundColor="rgba(0,0,0,0.5)",n.style.color="white",n.style.padding="5px",n.style.borderRadius="4px",n.style.fontSize="12px",n.style.zIndex="999",n.innerHTML="Эта рамка показывает область, которая будет сохранена",t.appendChild(n)}console.log("📐 Обновление трансформации:",{imageScale:this.state.imageScale,imageX:this.state.imageX,imageY:this.state.imageY,viewportWidth:t.clientWidth,viewportHeight:t.clientHeight,naturalWidth:e.naturalWidth,naturalHeight:e.naturalHeight})}},handleVideoLoaded(e){console.log("Функция обработки видео отключена")},setupVideoSliders(){},updateVideoSliders(){},updateTimeDisplay(){endTimeEl&&(endTimeEl.textContent=this.state.videoEnd.toFixed(1)),durationEl&&(durationEl.textContent=(this.state.videoEnd-this.state.videoStart).toFixed(1))},showMessage(e,t="info"){const i=document.querySelector(".media-editor-message");i&&i.remove();const l=document.createElement("div");if(l.className=`media-editor-message alert alert-${t==="success"?"success":t==="error"?"danger":"info"}`,l.style.cssText=`
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            animation: slideDown 0.3s ease-out;
        `,l.textContent=e,!document.querySelector("#media-editor-styles")){const d=document.createElement("style");d.id="media-editor-styles",d.textContent=`
                @keyframes slideDown {
                    from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                    to { transform: translateX(-50%) translateY(0); opacity: 1; }
                }
            `,document.head.appendChild(d)}document.body.appendChild(l),setTimeout(()=>{l&&l.parentNode&&l.remove()},t==="error"?5e3:3e3)},async handleSave(){var t;if(console.log("🚀 MediaEditor.handleSave: Начало процесса сохранения"),console.log("📊 Состояние редактора:",{currentFile:this.state.currentFile?{name:this.state.currentFile.name,type:this.state.currentFile.type,size:this.state.currentFile.size}:null,currentFileType:this.state.currentFileType}),!this.state.currentFile){console.error("❌ Нет файла для сохранения"),alert("Сначала выберите файл для обработки");return}console.log("📁 Сохраняем файл:",{name:this.state.currentFile.name,type:this.state.currentFileType,size:this.state.currentFile.size}),this.showProcessing();const e=document.getElementById("saveBtn");e&&(e.disabled=!0,e.innerHTML='<i class="bi bi-hourglass-split me-2"></i>Обработка...');try{const i=new FormData;i.append("media_file",this.state.currentFile),console.log("📝 Добавляем данные в FormData...");{const r=document.getElementById("imageViewport"),c=document.getElementById("imagePreview"),n=r?r.getBoundingClientRect():null,g=c?c.getBoundingClientRect():null,y=c?window.getComputedStyle(c).transform:"none",v=n?n.width:0,E=n?n.height:0,p=c?c.naturalWidth:0,w=c?c.naturalHeight:0,M=c.getBoundingClientRect(),f={left:this.state.imageX<0?Math.abs(this.state.imageX)/this.state.imageScale:0,top:this.state.imageY<0?Math.abs(this.state.imageY)/this.state.imageScale:0},a={left:f.left,top:f.top,width:v/this.state.imageScale,height:E/this.state.imageScale};a.left+a.width>p&&console.warn("⚠️ Ширина области выходит за пределы изображения",{visibleBoxRight:a.left+a.width,origWidth:p}),a.top+a.height>w&&console.warn("⚠️ Высота области выходит за пределы изображения",{visibleBoxBottom:a.top+a.height,origHeight:w}),console.log("🔍 Вычисленный видимый прямоугольник:",{left:a.left,top:a.top,width:a.width,height:a.height,imageScale:this.state.imageScale,imageX:this.state.imageX,imageY:this.state.imageY,viewportWidth:v,viewportHeight:E,origWidth:p,origHeight:w,viewportToImageCoords:f});try{let m=document.getElementById("debug-crop-area");if(!m&&viewport){const u=document.createElement("div");u.id="debug-crop-area",u.style.position="absolute",u.style.border="2px solid yellow",u.style.pointerEvents="none",u.style.zIndex="1000",viewport.appendChild(u),m=u}if(m){const u=this.state.imageX+f.left*this.state.imageScale,b=this.state.imageY+f.top*this.state.imageScale,B=a.width*this.state.imageScale,I=a.height*this.state.imageScale;m.style.left=u+"px",m.style.top=b+"px",m.style.width=B+"px",m.style.height=I+"px"}}catch(m){console.error("Ошибка при создании отладочного элемента",m)}a.left+a.width>p&&(a.width=p-a.left),a.top+a.height>w&&(a.height=w-a.top),a.left=Math.max(0,Math.min(p-1,a.left)),a.top=Math.max(0,Math.min(w-1,a.top)),a.width=Math.max(1,Math.min(p-a.left,a.width)),a.height=Math.max(1,Math.min(w-a.top,a.height));const x={scale:this.state.imageScale,x:this.state.imageX,y:this.state.imageY,format:"reels",aspectRatio:"9:16",viewportWidth:v,viewportHeight:E,imageWidth:g?g.width:0,imageHeight:g?g.height:0,originalWidth:p,originalHeight:w,crop:{left:a.left,top:a.top,width:a.width,height:a.height}};i.append("crop_data",JSON.stringify(x)),console.log("🖼️ Добавлены данные изображения для формата Reels:",x)}const l=document.getElementById("templateId");l&&(i.append("template_id",l.value),console.log("🏷️ Добавлен ID шаблона:",l.value));const d=document.getElementById("returnUrl");d&&(i.append("return_url",d.value),console.log("🔙 Добавлен URL для возврата:",d.value));const o=document.querySelector('meta[name="csrf-token"]');if(!o)throw new Error("CSRF токен не найден на странице");console.log("🔐 CSRF токен найден"),console.log("🌐 Отправляем запрос на /media/process...");const s=await fetch("/media/process",{method:"POST",body:i,headers:{"X-CSRF-TOKEN":o.getAttribute("content")}});if(console.log("📡 Получен ответ от сервера:",{status:s.status,statusText:s.statusText,ok:s.ok}),!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const h=await s.json();if(console.log("📋 Результат обработки:",h),h.success){console.log("✅ Файл успешно сохранён!"),this.showMessage("Файл успешно обработан! Переходим к созданию шаблона...","success"),e&&(e.innerHTML='<i class="bi bi-check-circle me-2"></i>Успешно!',e.classList.remove("btn-primary"),e.classList.add("btn-success"));let r=h.return_url||((t=document.getElementById("returnUrl"))==null?void 0:t.value);r?console.log("🔄 Перенаправляем на:",r):(r="/templates/create",console.log("🔄 URL для перенаправления не найден, используем URL по умолчанию:",r)),setTimeout(()=>{console.log("🚀 Выполняем перенаправление на:",r),window.location.href=r},1e3)}else throw new Error(h.message||"Ошибка при сохранении файла")}catch(i){console.error("❌ Ошибка при сохранении:",i),this.showMessage("Произошла ошибка: "+i.message,"error"),e&&(e.disabled=!1,e.innerHTML='<i class="bi bi-check-lg me-2"></i>Далее',e.classList.remove("btn-success"),e.classList.add("btn-primary"))}finally{this.hideProcessing(),console.log("🏁 MediaEditor.handleSave: Процесс завершен")}},handleReset(){this.state.currentFile=null,this.state.currentFileType=null,this.hideSection("imageEditorSection"),this.hideSection("videoEditorSection"),this.hideSection("actionButtons"),this.showSection("uploadSection");const e=document.getElementById("mediaFile");e&&(e.value="")},showSection(e){const t=document.getElementById(e);t&&(t.style.display="block")},hideSection(e){const t=document.getElementById(e);t&&(t.style.display="none")},showProcessing(){const e=document.getElementById("processingIndicator");e&&(e.style.display="block")},hideProcessing(){const e=document.getElementById("processingIndicator");e&&(e.style.display="none")}};document.addEventListener("DOMContentLoaded",()=>{console.log("🚀 Инициализация MediaEditor"),S.init(),window.MediaEditor=S,window.processMedia=function(){return console.log("🔧 processMedia: Функция вызвана"),window.MediaEditor&&typeof window.MediaEditor.handleSave=="function"?(console.log("✅ processMedia: MediaEditor найден, вызываем handleSave"),window.MediaEditor.handleSave.call(window.MediaEditor)):(console.error("❌ processMedia: MediaEditor не инициализирован или handleSave недоступен"),console.log("Доступные объекты:",{MediaEditor:!!window.MediaEditor,handleSave:window.MediaEditor?typeof window.MediaEditor.handleSave:"MediaEditor отсутствует"}),setTimeout(()=>{window.location.href="/template-editor/edit/1"},300),!1)},console.log("✅ MediaEditor успешно инициализирован и доступен глобально")});window.MediaEditor=S;
