/**
 * –†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤
 * –í–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –¥–∞—Ç —Å –ø–æ–º–æ—â—å—é –∫–∞–ª–µ–Ω–¥–∞—Ä—è
 * –î–∞—Ç–∞: 4 –∏—é–ª—è 2025 –≥.
 */

// –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç TemplateEditor –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
// –ï—Å–ª–∏ –æ–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ–º –µ–≥–æ
const TemplateEditor = (function() {
    // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const state = {
        activeElement: null,
        datePickerInstances: {},
        editableElements: {},
        unsavedChanges: false,
        calendar: null
    };
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è 
    const config = {
    editableSelector: '[data-editable]',
    dateFieldSelector: '[data-field-type="date"]',
    editingClass: 'editing',
    dateFormat: 'DD.MM.YYYY',
    calendarContainerClass: 'template-date-container',
        datePickerOptions: {
            locale: 'ru',
            dateFormat: 'd.m.Y',
            altInput: true,
            altFormat: 'd.m.Y',
            disableMobile: true
        }
    };
    
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
     * @param {string} dateString - —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞—Ç–æ–π
     * @param {string} format - —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é DD.MM.YYYY)
     * @returns {string} - –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
     */
    function formatDate(dateString, format = config.dateFormat) {
        const date = new Date(dateString.split('.').reverse().join('-'));
        
        if (isNaN(date)) {
            return dateString; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        
        switch (format.toUpperCase()) {
            case 'DD.MM.YYYY':
                return `${day}.${month}.${year}`;
            case 'MM.DD.YYYY':
                return `${month}.${day}.${year}`;
            case 'YYYY-MM-DD':
                return `${year}-${month}-${day}`;
            default:
                return `${day}.${month}.${year}`;
        }
    }

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –∏–∑ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤ –¥—Ä—É–≥–æ–π
     * @param {string} dateValue - –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—ã
     * @param {string} fromFormat - –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, DD.MM.YYYY)
     * @param {string} toFormat - —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, YYYY-MM-DD)
     * @returns {string} - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è –¥–∞—Ç–∞
     */
    function convertDateFormat(dateValue, fromFormat, toFormat) {
        let day, month, year;
        
        if (fromFormat.toUpperCase() === 'DD.MM.YYYY') {
            [day, month, year] = dateValue.split('.');
        } else if (fromFormat.toUpperCase() === 'YYYY-MM-DD') {
            [year, month, day] = dateValue.split('-');
        } else {
            return dateValue; // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        }
        
        if (toFormat.toUpperCase() === 'DD.MM.YYYY') {
            return `${day}.${month}.${year}`;
        } else if (toFormat.toUpperCase() === 'YYYY-MM-DD') {
            return `${year}-${month}-${day}`;
        }
        
        return dateValue;
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
     */
    function createSimpleDatePicker() {
        const calendarContainer = document.createElement('div');
        calendarContainer.className = config.calendarContainerClass;
        calendarContainer.style.display = 'none';
        document.body.appendChild(calendarContainer);
        
        return calendarContainer;
    }
    
    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–≤–æ–¥–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
     * @param {HTMLElement} element - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
     */
    function createEditableInput(element) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const currentValue = element.innerText.trim();
        
        // –î–µ–ª–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º —Å –ø–æ–º–æ—â—å—é contentEditable
        element.contentEditable = 'true';
        element.dataset.originalValue = currentValue;
        element.classList.add('editing');
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ
        element.focus();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(element);
        range.collapse(false); // false –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–æ–ª–ª–∞–ø—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫ –∫–æ–Ω—Ü—É —É–∑–ª–∞
        selection.removeAllRanges();
        selection.addRange(range);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è contentEditable
        function handleBlur() {
            finishEditing(element, element.textContent.trim());
            element.removeEventListener('blur', handleBlur);
            element.removeEventListener('keydown', handleKeyDown);
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                element.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                element.textContent = element.dataset.originalValue;
                element.blur();
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
        element.addEventListener('blur', handleBlur);
        element.addEventListener('keydown', handleKeyDown);
    }

    /**
     * –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
     * @param {HTMLElement} element - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç
     * @param {string} value - –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
     */
    function finishEditing(element, value) {
        const fieldName = element.getAttribute('data-editable');
        const fieldType = element.getAttribute('data-field-type') || 'text';
        
        // –î–µ–ª–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–º
        element.contentEditable = 'false';
        
        // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        element.classList.remove(config.editingClass);
        element.classList.remove('editing');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (element.textContent.trim() !== value) {
            element.textContent = value;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state.activeElement = null;
        state.unsavedChanges = true;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state.editableElements[fieldName] = {
            value: value,
            type: fieldType
        };
        
        // –û–ø–æ–≤–µ—â–∞–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        document.dispatchEvent(new CustomEvent('template-editor:change', {
            detail: {
                fieldName,
                value,
                fieldType
            }
        }));
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è –ø–æ–ª—è —Å –¥–∞—Ç–æ–π
     * @param {HTMLElement} element - —ç–ª–µ–º–µ–Ω—Ç –¥–∞—Ç—ã
     */
    function initDatePicker(element) {
        const fieldName = element.getAttribute('data-editable');
        const dateFormat = element.getAttribute('data-date-format') || 'dd.mm.yyyy';
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        if (!element.id) {
            element.id = `date-field-${fieldName}-${Date.now()}`;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        if (state.datePickerInstances[element.id]) {
            return;
        }
        
        // –û–ø—Ü–∏–∏ –¥–ª—è flatpickr
        const options = {
            ...config.datePickerOptions,
            defaultDate: element.innerText.trim(),
            onChange: function(_, dateStr) {
                finishEditing(element, dateStr);
                this.close();
            }
        };
        
        // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º flatpickr
        if (window.flatpickr) {
            state.datePickerInstances[element.id] = flatpickr(element, options);
            return;
        }
        
        // –ï—Å–ª–∏ flatpickr –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç
        if (!state.calendar) {
            state.calendar = createSimpleDatePicker();
        }
        updateSimpleCalendar(state.calendar, element);
    }
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} container - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} dateElement - —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∞—Ç–æ–π
     */
    function initSimpleCalendar(container, dateElement) {
        const currentValue = dateElement.innerText.trim();
        let [day, month, year] = currentValue.split('.');
        
        day = parseInt(day, 10);
        month = parseInt(month, 10) - 1; // –í JavaScript –º–µ—Å—è—Ü—ã –æ—Ç 0 –¥–æ 11
        year = parseInt(year, 10);
        
        const date = new Date(year, month, day);
        
        if (isNaN(date)) {
            // –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é
            date = new Date();
        }
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        container.innerHTML = createSimpleCalendarHTML(date);
        container.style.display = 'block';
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        positionCalendar(container, dateElement);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        addSimpleCalendarHandlers(container, dateElement);
    }

    /**
     * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} container - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} dateElement - —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∞—Ç–æ–π
     */
    function updateSimpleCalendar(container, dateElement) {
        initSimpleCalendar(container, dateElement);
    }

    /**
     * –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {Date} date - –¥–∞—Ç–∞
     * @returns {string} - HTML —Ä–∞–∑–º–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     */
    function createSimpleCalendarHTML(date) {
        const year = date.getFullYear();
        const month = date.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDay = new Date(year, month, 1).getDay(); // 0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
        
        // –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
        
        // –°—Ç—Ä–æ–∏–º HTML –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        let html = `
            <div class="simple-calendar-header">
                <button type="button" class="prev-month">&lt;</button>
                <div class="current-month">${monthNames[month]} ${year}</div>
                <button type="button" class="next-month">&gt;</button>
            </div>
            <table class="simple-calendar-table">
                <thead>
                    <tr>
                        <th>–ü–Ω</th>
                        <th>–í—Ç</th>
                        <th>–°—Ä</th>
                        <th>–ß—Ç</th>
                        <th>–ü—Ç</th>
                        <th>–°–±</th>
                        <th>–í—Å</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Ç.–¥.)
        let dayOfWeek = firstDay === 0 ? 6 : firstDay - 1; // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å)
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ
        html += '<tr>';
        for (let i = 0; i < dayOfWeek; i++) {
            html += '<td></td>';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
        let currentDay = 1;
        while (currentDay <= daysInMonth) {
            if (dayOfWeek === 7) {
                dayOfWeek = 0;
                html += '</tr><tr>';
            }
            
            const isToday = currentDay === date.getDate();
            const dayClass = isToday ? 'today' : '';
            
            html += `<td class="calendar-day ${dayClass}" data-day="${currentDay}">${currentDay}</td>`;
            
            dayOfWeek++;
            currentDay++;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –∫–æ–Ω—Ü–µ
        for (let i = dayOfWeek; i < 7; i++) {
            html += '<td></td>';
        }
        
        html += '</tr></tbody></table>';
        
        return html;
    }

    /**
     * –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Ä—è–¥–æ–º —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º
     * @param {HTMLElement} calendar - —ç–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} element - —ç–ª–µ–º–µ–Ω—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—å
     */
    function positionCalendar(calendar, element) {
        const rect = element.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        calendar.style.position = 'absolute';
        calendar.style.zIndex = '1000';
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–æ–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–º
        calendar.style.top = `${rect.bottom + scrollTop}px`;
        calendar.style.left = `${rect.left + scrollLeft}px`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
        const calendarRect = calendar.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        
        if (calendarRect.right > viewportWidth) {
            calendar.style.left = `${rect.right + scrollLeft - calendarRect.width}px`;
        }
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ –ø—Ä–æ—Å—Ç–æ–º—É –∫–∞–ª–µ–Ω–¥–∞—Ä—é
     * @param {HTMLElement} calendar - —ç–ª–µ–º–µ–Ω—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—è
     * @param {HTMLElement} dateElement - —ç–ª–µ–º–µ–Ω—Ç —Å –¥–∞—Ç–æ–π
     */
    function addSimpleCalendarHandlers(calendar, dateElement) {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        calendar.addEventListener('click', function(e) {
            const dayCell = e.target.closest('.calendar-day');
            if (dayCell) {
                const day = parseInt(dayCell.getAttribute('data-day'), 10);
                const monthYear = calendar.querySelector('.current-month').textContent;
                const [monthName, year] = monthYear.split(' ');
                
                const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
                const month = monthNames.indexOf(monthName) + 1;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                const formattedDate = `${day.toString().padStart(2, '0')}.${month.toString().padStart(2, '0')}.${year}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                finishEditing(dateElement, formattedDate);
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                calendar.style.display = 'none';
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const prevButton = calendar.querySelector('.prev-month');
        prevButton.addEventListener('click', function() {
            const monthYear = calendar.querySelector('.current-month').textContent;
            const [monthName, year] = monthYear.split(' ');
            
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            let month = monthNames.indexOf(monthName);
            let newYear = parseInt(year, 10);
            
            if (month === 0) {
                month = 11; // –î–µ–∫–∞–±—Ä—å
                newYear -= 1;
            } else {
                month -= 1;
            }
            
            const newDate = new Date(newYear, month, 1);
            calendar.innerHTML = createSimpleCalendarHTML(newDate);
            addSimpleCalendarHandlers(calendar, dateElement);
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const nextButton = calendar.querySelector('.next-month');
        nextButton.addEventListener('click', function() {
            const monthYear = calendar.querySelector('.current-month').textContent;
            const [monthName, year] = monthYear.split(' ');
            
            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
            let month = monthNames.indexOf(monthName);
            let newYear = parseInt(year, 10);
            
            if (month === 11) {
                month = 0; // –Ø–Ω–≤–∞—Ä—å
                newYear += 1;
            } else {
                month += 1;
            }
            
            const newDate = new Date(newYear, month, 1);
            calendar.innerHTML = createSimpleCalendarHTML(newDate);
            addSimpleCalendarHandlers(calendar, dateElement);
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function handleOutsideClick(e) {
            if (!calendar.contains(e.target) && e.target !== dateElement) {
                calendar.style.display = 'none';
                document.removeEventListener('click', handleOutsideClick);
            }
        });
    }

    /**
     * –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
     * @returns {Object} –æ–±—ä–µ–∫—Ç —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
     */
    function getEditableElements() {
        return state.editableElements;
    }
    
    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
     */
    function init() {
        console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤...');
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const editableElements = document.querySelectorAll(config.editableSelector);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        editableElements.forEach(element => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
            if (element.hasAttribute('data-initialized-inline-editor') || 
                element.hasAttribute('data-template-editor-disabled')) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
            }
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        editableElements.forEach(element => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
            if (element.hasAttribute('data-initialized-inline-editor') || 
                element.hasAttribute('data-template-editor-disabled')) {
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥—Ä—É–≥–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º
            }
            
            const fieldId = element.getAttribute('data-editable');
            const fieldType = element.getAttribute('data-field-type') || 'text';
            const value = element.innerText.trim();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            state.editableElements[fieldId] = {
                value: value,
                type: fieldType
            };
                if (state.activeElement === element) {
                    return;
                }
                
                // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –∑–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                if (state.activeElement) {
                    if (state.activeElement.contentEditable === 'true') {
                        // –î–ª—è contentEditable —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        state.activeElement.blur();
                    } else {
                        // –î–ª—è —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å input (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                        const input = state.activeElement.querySelector('.inline-edit-input');
                        if (input) {
                            input.blur();
                        }
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                element.classList.add(config.editingClass);
                state.activeElement = element;
                
                // –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø–æ–ª—è
                if (fieldType === 'date') {
                    initDatePicker(element);
                } else {
                    createEditableInput(element);
                }
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Escape –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && state.activeElement) {
                if (state.activeElement.contentEditable === 'true') {
                    // –î–ª—è contentEditable —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (state.activeElement.dataset.originalValue) {
                        state.activeElement.textContent = state.activeElement.dataset.originalValue;
                    }
                    state.activeElement.blur();
                } else {
                    // –î–ª—è —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å input (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                    const input = state.activeElement.querySelector('.inline-edit-input');
                    if (input) {
                        input.value = input.dataset.originalValue;
                        input.blur();
                    }
                }
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        if (typeof window.saveTemplateData === 'undefined') {
            window.saveTemplateData = function() {
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞...');
                console.log('–†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã:', state.editableElements);
                
                // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                document.dispatchEvent(new CustomEvent('template-editor:save', {
                    detail: {
                        elements: state.editableElements
                    }
                }));
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
                state.unsavedChanges = false;
                
                return state.editableElements;
            };
        }
        
        console.log('–†–µ–¥–∞–∫—Ç–æ—Ä —à–∞–±–ª–æ–Ω–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
    }
    
    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è –∏–∑ inline-editor
     * @param {string} fieldId - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—è
     * @param {string} newValue - –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è
     * @param {string} fieldType - —Ç–∏–ø –ø–æ–ª—è (text, date –∏ —Ç.–¥.)
     */
    function handleFieldChanged(fieldId, newValue, fieldType) {
        console.log(`üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—è ${fieldId}: ${newValue} (${fieldType})`);
        
        if (!state.editableElements[fieldId]) {
            state.editableElements[fieldId] = {
                value: newValue,
                type: fieldType
            };
        } else {
            state.editableElements[fieldId].value = newValue;
        }
        
        state.unsavedChanges = true;
    }

    /**
     * –û—Ç–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
     * @param {HTMLElement} element - —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
     */
    function disableElementHandlers(element) {
        if (!element) return;
        
        // –ü–æ–º–µ—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∫–∞–∫ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —à–∞–±–ª–æ–Ω–æ–≤
        element.setAttribute('data-template-editor-disabled', 'true');
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ–ª–µ –¥–∞—Ç—ã, –æ—Ç–∫–ª—é—á–∞–µ–º –µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        const fieldName = element.getAttribute('data-editable');
        if (fieldName && state.datePickerInstances[fieldName]) {
            try {
                state.datePickerInstances[fieldName].destroy();
                delete state.datePickerInstances[fieldName];
                console.log(`üîî –û—Ç–∫–ª—é—á–µ–Ω –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –ø–æ–ª—è ${fieldName} –≤ —Å—Ç–∞—Ä–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ`);
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –¥–ª—è ${fieldName}:`, error);
            }
        }
    }

    // –ü—É–±–ª–∏—á–Ω—ã–π API
    return {
        init,
        getEditableElements,
        formatDate,
        convertDateFormat,
        onFieldChanged: handleFieldChanged,
        disableElementHandlers,
        hasUnsavedChanges: function() { return state.unsavedChanges; }
    };
})();

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.TemplateEditor = TemplateEditor;

// CSS –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const calendarStyles = `
.simple-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 5px 0;
    background-color:rgb(0, 0, 0);
    color: white;
    border-radius: 4px;
}

.simple-calendar-header button {
    background: none;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
}

.simple-calendar-header button:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.simple-calendar-table {
    width: 100%;
    border-collapse: collapse;
}

.simple-calendar-table th {
    padding: 8px;
    text-align: center;
    font-weight: normal;
    color: #666;
}

.simple-calendar-table td {
    padding: 8px;
    text-align: center;
    cursor: pointer;
    border-radius: 4px;
}

.simple-calendar-table td.calendar-day:hover {
    background-color: rgba(76, 175, 80, 0.1);
}

.simple-calendar-table td.today {
    background-color: rgba(76, 175, 80, 0.2);
    font-weight: bold;
    color: #4CAF50;
}

.template-date-container {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 10px;
    width: 280px;
}
`;

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –≤ head
function addCalendarStyles() {
    const styleElement = document.createElement('style');
    styleElement.textContent = calendarStyles;
    document.head.appendChild(styleElement);
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.TemplateEditor = TemplateEditor;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤ –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–∞—Ö
(function() {
    try {
        addCalendarStyles();
        if (TemplateEditor && TemplateEditor.init) {
            TemplateEditor.init();
            console.log('‚úÖ TemplateEditor –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
        }
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TemplateEditor:', e);
    }
})();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    addCalendarStyles();
    if (TemplateEditor && TemplateEditor.init) {
        TemplateEditor.init();
        console.log('‚úÖ TemplateEditor —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
    } else {
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    addCalendarStyles();
    if (TemplateEditor && TemplateEditor.init) {
        TemplateEditor.init();
        console.log('‚úÖ TemplateEditor —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
    } else {
        console.error('‚ùå TemplateEditor –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥–∞ init');
    }
    
    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
    window.addEventListener('beforeunload', function(e) {
        if (TemplateEditor && TemplateEditor.hasUnsavedChanges && TemplateEditor.hasUnsavedChanges()) {
            // Modern browsers require the user to interact with the dialog
            const message = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
            // For older browsers
            if (e) {
                e.preventDefault();
                // Note: returnValue is deprecated but still needed for older browsers
                e.returnValue = message;
            }
            return message; // For modern browsers
        }
    });
